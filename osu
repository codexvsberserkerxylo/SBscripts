local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

local BASE_PITCH = 1.0
local PITCH_INCREMENT = 0.015
local MAX_PITCH = 2.25

local function setupPlayer(player)
	local pGui = player:FindFirstChildOfClass("PlayerGui")
	if not pGui then return end

	local sound = player:FindFirstChild("osu") or Instance.new("Sound")
	sound.Name = "osu"
	sound.SoundId = "rbxassetid://7172607676"
	sound.Volume = 0.8
	sound.Parent = player 

	local function applySound(textBox)
		if textBox:GetAttribute("SoundHooked") then return end
		textBox:SetAttribute("SoundHooked", true)
		
		textBox:GetPropertyChangedSignal("Text"):Connect(function()
			local textLength = #textBox.Text
			local currentPitch = textLength == 0 and BASE_PITCH or math.min(BASE_PITCH + (textLength * PITCH_INCREMENT), MAX_PITCH)
			
			sound.PlaybackSpeed = currentPitch
			sound:Stop()
			sound.TimePosition = 0
			sound:Play()
		end)
	end

	local function hookGui(gui)
		if gui.Name == "Type" then
			gui:GetPropertyChangedSignal("Enabled"):Connect(function()
				if gui.Enabled then
					sound.PlaybackSpeed = BASE_PITCH
					sound:Stop()
					sound.TimePosition = 0
					sound:Play()
				end
			end)

			local textBox = gui:FindFirstChildWhichIsA("TextBox", true)
			if textBox then applySound(textBox) end
			
			gui.DescendantAdded:Connect(function(desc)
				if desc:IsA("TextBox") then applySound(desc) end
			end)
		end
	end

	for _, child in ipairs(pGui:GetChildren()) do
		hookGui(child)
	end
	pGui.ChildAdded:Connect(hookGui)
end

for _, player in ipairs(Players:GetPlayers()) do
	task.spawn(setupPlayer, player)
end

Players.PlayerAdded:Connect(setupPlayer)
